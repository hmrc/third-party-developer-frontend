@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.govukfrontend.views.html.components._
@import include._
@import uk.gov.hmrc.thirdpartydeveloperfrontend.domain.models.controllers.Crumb
@import uk.gov.hmrc.thirdpartydeveloperfrontend.domain.models.controllers.ApplicationViewModel
@import uk.gov.hmrc.thirdpartydeveloperfrontend.domain.models.apidefinitions.APISubscriptionStatus
@import uk.gov.hmrc.apiplatform.modules.tpd.session.domain.models.UserSession
@import uk.gov.hmrc.thirdpartydeveloperfrontend.controllers.routes
@import uk.gov.hmrc.apiplatform.modules.applications.core.domain.models._
@import uk.gov.hmrc.apiplatform.modules.applications.submissions.domain.models.{PrivacyPolicyLocations, TermsAndConditionsLocations}
@import uk.gov.hmrc.thirdpartydeveloperfrontend.domain.models.applications.ApplicationSyntaxes._
@import java.util.Locale
@import java.time.Instant
@import java.time.ZoneId
@import java.time.format.DateTimeFormatter

@this(
  devMain: DevMain, 
  govukTable: GovukTable
)

@(applicationViewModel: ApplicationViewModel, subscriptions: List[APISubscriptionStatus])(
        implicit request: play.api.mvc.Request[Any],
        loggedIn: UserSession,
        messages: Messages,
        appConfig: ApplicationConfig,
        navSection: String = "details"
)

@formatMaybeDate(maybeDate: Option[Instant], dateFormatter: DateTimeFormatter, defaultString: String) = @{
  maybeDate match {
    case Some(date) => dateFormatter.format(date)
    case _          => defaultString
  }
}

@app = @{applicationViewModel.application}

@devMain(
  title = messages("application.details"),
  userFullName = loggedIn.loggedInName,
  breadcrumbs = Seq(
    Crumb.viewAllApplications,
    Crumb.home
  ),
  leftNav = None,
  developerSession = Some(loggedIn)
) {

  <h1 class="govuk-heading-l">
    <span class="govuk-caption-l">@{app.details.name.toString()}</span>
    @messages("application.details")
  </h1>

  @defining(DateTimeFormatter.ofPattern("d MMMM yyyy").withZone(ZoneId.of("Europe/London")).withLocale(Locale.UK)) { dateFormatter =>
      @govukTable(Table(
          firstCellIsHeader = true,
          rows = Seq(
            Seq(TableRow(content = Text(messages("application.details.name"))), TableRow(content = Text(app.details.name.toString()), attributes = Map("id" -> "applicationName"))),
            Seq(TableRow(content = Text(messages("application.details.environment"))), TableRow(content = Text(app.details.deployedTo.displayText), attributes = Map("id" -> "environment"))),
            Seq(TableRow(content = Text(messages("application.details.created"))), TableRow(content = Text(dateFormatter.format(app.details.createdOn)), attributes = Map("id" -> "createdOn"))),
            Seq(TableRow(content = Text(messages("application.details.last.api.call"))), TableRow(content = Text(formatMaybeDate(app.details.lastAccess, dateFormatter, "No API called")), attributes = Map("id" -> "lastAccess"))),
            Seq(TableRow(content = Text(messages("application.details.description"))), TableRow(content = Text(app.details.description.getOrElse("None")), attributes = Map("id" -> "description")))
          )
      ))
  }

  <h2 class="govuk-heading-m">@messages("application.details.apis.added")</h2>
  <p class="govuk-body">@messages("application.details.apis.hint")</p>

  @govukTable(Table(
    head = Some(Seq(
      HeadCell(content = Text(messages("application.details.api.name")))
    )),
    rows = subscriptions.filter(sub => sub.subscribed == true).map(subscription => Seq(
      TableRow(content = Text(s"${subscription.name} ${subscription.apiVersion.versionNbr.toString()}"))
    ))
  ))

  <h2 class="govuk-heading-m">@messages("application.details.authorisation.details")</h2>
  <p class="govuk-body">@messages("application.details.authorisation.hint")</p>

  @govukTable(Table(
      firstCellIsHeader = true,
      rows = Seq(
        Seq(TableRow(content = Text(messages("application.details.client.id"))), TableRow(content = Text(app.details.token.clientId.toString()), attributes = Map("id" -> "clientId"))),
        Seq(TableRow(content = Text(messages("application.details.client.secrets"))), TableRow(content = Text(""))),
        Seq(TableRow(content = Text(messages("application.details.redirect.uris"))), TableRow(content = Text("None added"))),
        Seq(TableRow(content = Text(messages("application.details.ip.allow.list"))), TableRow(content = Text("No IP addresses added")))
      )
  ))

  <h2 class="govuk-heading-m">@messages("application.details.team.members")</h2>
  <p class="govuk-body">@messages("application.details.team.hint")</p>

  @govukTable(Table(
    head = Some(Seq(
      HeadCell(content = Text(messages("application.details.team.email"))),
      HeadCell(content = Text(messages("application.details.team.role")))
    )),
    rows = app.collaborators.toList.map(collaborator => Seq(
      TableRow(content = Text(collaborator.emailAddress.text)),
      TableRow(content = Text(collaborator.role.displayText))
    ))
  ))

  <h2 class="govuk-heading-m">@messages("application.details.customer.usage")</h2>
  <p class="govuk-body">@messages("application.details.customer.hint")</p>

  @govukTable(Table(
      firstCellIsHeader = true,
      rows = Seq(
        Seq(TableRow(content = Text(messages("application.details.privacy.policy.url"))), TableRow(content = Text(app.privacyPolicyLocation.getOrElse(PrivacyPolicyLocations.NoneProvided).describe()), attributes = Map("id" -> "privacyPolicy"))),
        Seq(TableRow(content = Text(messages("application.details.terms.conditions.url"))), TableRow(content = Text(app.termsAndConditionsLocation.getOrElse(TermsAndConditionsLocations.NoneProvided).describe()), attributes = Map("id" -> "termsAndConditions"))),
        Seq(TableRow(content = Text(messages("application.details.grant.length"))), TableRow(content = Text(app.details.grantLength.show()), attributes = Map("id" -> "grantLength")))
      )
  ))

}
