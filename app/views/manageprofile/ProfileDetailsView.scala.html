@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import uk.gov.hmrc.govukfrontend.views.html.components._
@import include._
@import uk.gov.hmrc.thirdpartydeveloperfrontend.domain.models.controllers.Crumb
@import uk.gov.hmrc.apiplatform.modules.tpd.session.domain.models.UserSession
@import uk.gov.hmrc.apiplatform.modules.tpd.core.domain.models.User
@import uk.gov.hmrc.apiplatform.modules.organisations.domain.models.Organisation
@import views.html.include.DevMain
@import uk.gov.hmrc.thirdpartydeveloperfrontend.controllers.routes
@import java.util.Locale
@import java.time.Instant
@import java.time.ZoneId
@import java.time.format.DateTimeFormatter

@this(
  devMain: DevMain, 
  govukTable: GovukTable
)

@(user: User, organisations: Seq[Organisation])(implicit request: play.api.mvc.Request[Any], loggedIn: UserSession, appConfig: ApplicationConfig, messages: Messages)

@formatListOfOrganisations(orgs: Seq[Organisation], defaultString: String) = @{
    orgs.isEmpty match {
        case false => orgs.map(org => org.organisationName.value)mkString("<br>")
        case true => defaultString
    }
}

@devMain(
  title = messages("profile.details"),
  userFullName = loggedIn.loggedInName,
  breadcrumbs = Seq(
    Crumb.viewAllApplications,
    Crumb.home
  ),
  leftNav = None,
  developerSession = Some(loggedIn)
) {

  <h1 class="govuk-heading-l">@messages("profile.details")</h1>

  <h2 class="govuk-heading-m">@messages("profile.details.your.details")</h2>

  @govukTable(Table(
    firstCellIsHeader = true,
    rows = Seq(
      Seq(TableRow(content = Text(messages("profile.details.name"))), TableRow(content = Text(user.displayedName), attributes = Map("id" -> "name"))),
      Seq(TableRow(content = Text(messages("profile.details.email"))), TableRow(content = Text(user.email.text), attributes = Map("id" -> "email"))),
      Seq(TableRow(content = Text(messages("profile.details.organisation"))), TableRow(content = HtmlContent(formatListOfOrganisations(organisations, "None")), attributes = Map("id" -> "organisation")))
    )
  ))

  <h2 class="govuk-heading-m govuk-!-margin-top-9">@messages("profile.details.security.preferences")</h2>
  <p class="govuk-body">
    @messages("profile.details.security.hint")
  </p>
  @defining(DateTimeFormatter.ofPattern("d MMMM yyyy 'at' h:mm a").withZone(ZoneId.of("Europe/London")).withLocale(Locale.UK)) { dateFormatter =>
    @govukTable(Table(
      firstCellIsHeader = true,
      rows = user.mfaDetails.map(mfaDetail => Seq(
        TableRow(content = Text(mfaDetail.mfaType.displayText)),
        TableRow(content = HtmlContent(s"${mfaDetail.name}<p class='govuk-body govuk-hint govuk-!-margin-bottom-1'>Added ${dateFormatter.format(mfaDetail.createdOn)}</p>"))
      ))
    ))
  }

  <h2 class="govuk-heading-m govuk-!-margin-top-9">@messages("profile.details.delete.account")</h2>
  <p class="govuk-body">
    @messages("profile.details.delete.hint")
  </p>
    <p class="govuk-body">
        <a class="govuk-link govuk-link--no-visited-state" href="@controllers.profile.routes.Profile.requestDeletion()" id="account-deletion">Request account deletion</a>
    </p>
}
